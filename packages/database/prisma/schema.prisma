// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================
// USER & AUTH TABLES
// ============================================

enum UserRole {
  VISITEUR
  GESTIONNAIRE
  ADMINISTRATEUR

  @@map("user_role")
}

enum AuthProvider {
  EMAIL
  GOOGLE
  FACEBOOK

  @@map("auth_provider")
}

model User {
  id            String       @id @default(uuid())
  email         String       @unique @db.VarChar(200)
  passwordHash  String?      @map("password_hash")
  provider      AuthProvider @default(EMAIL)
  providerId    String?      @map("provider_id")
  role          UserRole     @default(VISITEUR)
  active        Boolean      @default(true)
  prenom        String?      @db.VarChar(100)
  nom           String?      @db.VarChar(100)
  phone         String?      @db.VarChar(30)
  sexe          String?      @db.VarChar(10)    // M, F, Autre
  trancheAge    String?      @map("tranche_age") @db.VarChar(20) // 18-25, 26-35, etc.
  photoUrl      String?      @map("photo_url")
  lieuGereId    String?      @map("lieu_gere_id") // For GESTIONNAIRE: linked lieu
  createdAt     DateTime     @default(now()) @map("created_at")
  updatedAt     DateTime     @updatedAt @map("updated_at")

  @@index([email])
  @@index([role])
  @@map("users")
}

// ============================================
// GEOGRAPHIC TABLES
// ============================================

model District {
  id          String   @id @default(uuid())
  name        String   @unique @db.VarChar(100)
  description String?  @db.Text
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  communes Commune[]

  @@map("districts")
}

model Commune {
  id          String   @id @default(uuid())
  name        String   @unique @db.VarChar(100)
  description String?  @db.Text
  population  Int?
  superficie  Float?   // en km²
  bourgmestre String?  @db.VarChar(150)
  districtId  String?  @map("district_id")
  latitude    Decimal? @db.Decimal(10, 8)
  longitude   Decimal? @db.Decimal(11, 8)
  imageUrl    String?  @map("image_url")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  district  District?  @relation(fields: [districtId], references: [id])
  quartiers Quartier[]
  lieux     Lieu[]

  @@index([districtId])
  @@map("communes")
}

model Quartier {
  id            String   @id @default(uuid())
  communeId     String   @map("commune_id")
  name          String   @db.VarChar(100)
  population    Int?
  chefQuartier  String?  @map("chef_quartier") @db.VarChar(150)
  referenceAdresse String? @map("reference_adresse") @db.Text
  latitude      Decimal? @db.Decimal(10, 8)
  longitude     Decimal? @db.Decimal(11, 8)
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  commune Commune @relation(fields: [communeId], references: [id], onDelete: Cascade)
  lieux   Lieu[]

  @@unique([communeId, name])
  @@map("quartiers")
}

model ZoneSante {
  id                  String   @id @default(uuid())
  name                String   @unique @db.VarChar(100)
  description         String?  @db.Text
  communeResponsable  String?  @map("commune_responsable") @db.VarChar(100)
  population          Int?
  nombreAiresSante    Int?     @map("nombre_aires_sante")
  latitude            Decimal? @db.Decimal(10, 8)
  longitude           Decimal? @db.Decimal(11, 8)
  telephone           String?  @db.VarChar(50)
  email               String?  @db.VarChar(100)
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  // Relations
  lieux Lieu[]

  @@map("zones_sante")
}

// ============================================
// LOCATION & SERVICE TABLES
// ============================================

enum LieuType {
  HOPITAL
  CLINIQUE
  CENTRE_SANTE
  ADMINISTRATION
  MAISON_COMMUNALE
  COMMISSARIAT
  POLICE
  TRIBUNAL
  ECOLE
  UNIVERSITE
  GOUVERNORAT
  AUTRE

  @@map("lieu_type")
}

enum ServiceCategorie {
  ETAT_CIVIL
  SANTE
  JUSTICE
  EDUCATION
  IMPOTS
  URGENCE
  SOCIAL
  TRANSPORT
  SECURITE
  AUTRE

  @@map("service_categorie")
}

model Lieu {
  id          String   @id @default(uuid())
  nom         String   @db.VarChar(200)
  type        LieuType
  communeId   String?  @map("commune_id")
  quartierId  String?  @map("quartier_id")
  zoneSanteId String?  @map("zone_sante_id")
  adresse     String?  @db.Text
  reperes     String?  @db.Text
  telephone   String?  @db.VarChar(50)
  telephone2  String?  @map("telephone_2") @db.VarChar(50)
  email       String?  @db.VarChar(100)
  siteWeb     String?  @map("site_web") @db.VarChar(200)
  horaires    Json?
  latitude    Decimal? @db.Decimal(10, 8)
  longitude   Decimal? @db.Decimal(11, 8)
  photos      String[]
  verified    Boolean  @default(false)
  featured    Boolean  @default(false)
  responsable String?  @db.VarChar(200) // Captain, Director, etc.
  createdBy   String?  @map("created_by")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  commune           Commune?          @relation(fields: [communeId], references: [id])
  quartier          Quartier?         @relation(fields: [quartierId], references: [id])
  zoneSante         ZoneSante?        @relation(fields: [zoneSanteId], references: [id])
  servicesProposed  ServicePropose[]
  avis              Avis[]
  signalements      Signalement[]
  favoris           Favori[]

  @@index([communeId])
  @@index([quartierId])
  @@index([zoneSanteId])
  @@index([type])
  @@index([verified])
  @@map("lieux")
}

model ServicePropose {
  id                     String           @id @default(uuid())
  lieuId                 String           @map("lieu_id")
  categorie              ServiceCategorie
  nomService             String           @map("nom_service") @db.VarChar(200)
  description            String?          @db.Text
  documentsRequis        String[]         @map("documents_requis")
  prixOfficiel           Decimal?         @map("prix_officiel") @db.Decimal(12, 2)
  devise                 String           @default("FC") @db.VarChar(10)
  delai                  String?          @db.VarChar(100)
  procedure              String?          @db.Text
  conditionsParticulieres String?          @map("conditions_particulieres") @db.Text
  commentaire            String?          @db.Text
  actif                  Boolean          @default(true)
  createdAt              DateTime         @default(now()) @map("created_at")
  updatedAt              DateTime         @updatedAt @map("updated_at")

  // Relations
  lieu Lieu @relation(fields: [lieuId], references: [id], onDelete: Cascade)

  @@index([lieuId])
  @@index([categorie])
  @@index([nomService])
  @@map("services_proposes")
}

// ============================================
// GESTION DE LA VILLE TABLES
// ============================================

model Gouvernorat {
  id           String   @id @default(uuid())
  gouverneur   String   @db.VarChar(200)
  photoUrl     String?  @map("photo_url")
  adresse      String?  @db.Text
  telephone    String?  @db.VarChar(50)
  email        String?  @db.VarChar(100)
  siteWeb      String?  @map("site_web") @db.VarChar(200)
  description  String?  @db.Text
  biographie   String?  @db.Text
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  ministres    Ministre[]

  @@map("gouvernorat")
}

model Ministre {
  id             String   @id @default(uuid())
  gouvernoratId  String   @map("gouvernorat_id")
  nom            String   @db.VarChar(200)
  portefeuille   String   @db.VarChar(200)  // Ministère
  type           String   @default("MINISTRE") @db.VarChar(50) // MINISTRE or COMMISSAIRE_GENERAL
  photoUrl       String?  @map("photo_url")
  telephone      String?  @db.VarChar(50)
  email          String?  @db.VarChar(100)
  biographie     String?  @db.Text
  ordre          Int      @default(0)
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  gouvernorat    Gouvernorat @relation(fields: [gouvernoratId], references: [id], onDelete: Cascade)

  @@map("ministres")
}

model Depute {
  id            String   @id @default(uuid())
  nom           String   @db.VarChar(200)
  parti         String?  @db.VarChar(100)
  circonscription String? @db.VarChar(150)
  photoUrl      String?  @map("photo_url")
  telephone     String?  @db.VarChar(50)
  email         String?  @db.VarChar(100)
  biographie    String?  @db.Text
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@map("deputes")
}

model GouverneurHistorique {
  id         String   @id @default(uuid())
  nom        String   @db.VarChar(200)
  photoUrl   String?  @map("photo_url")
  dateDebut  String?  @map("date_debut") @db.VarChar(50)
  dateFin    String?  @map("date_fin") @db.VarChar(50)
  biographie String?  @db.Text
  ordre      Int      @default(0)
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  @@map("gouverneurs_historiques")
}

model Projet {
  id            String   @id @default(uuid())
  titre         String   @db.VarChar(300)
  description   String   @db.Text
  statut        String   @default("EN_COURS") @db.VarChar(30) // EN_COURS, TERMINE, PLANIFIE
  budget        Decimal? @db.Decimal(15, 2)
  devise        String   @default("USD") @db.VarChar(10)
  dateDebut     DateTime? @map("date_debut")
  dateFin       DateTime? @map("date_fin")
  localisation  String?  @db.VarChar(200)
  maitreDoeuvre String?  @map("maitre_doeuvre") @db.VarChar(200)
  photos        String[]
  categorie     String?  @db.VarChar(100) // Infrastructure, Santé, Éducation, etc.
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@map("projets")
}

// ============================================
// USER INTERACTION TABLES
// ============================================

model Avis {
  id             String    @id @default(uuid())
  lieuId         String    @map("lieu_id")
  userId         String?   @map("user_id")
  userName       String?   @map("user_name") @db.VarChar(100)
  note           Int       // 1-5
  commentaire    String?   @db.Text
  dateExperience DateTime? @map("date_experience") @db.Date
  approved       Boolean   @default(true)
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  // Relations
  lieu Lieu @relation(fields: [lieuId], references: [id], onDelete: Cascade)

  @@index([lieuId])
  @@index([userId])
  @@map("avis_utilisateurs")
}

enum SignalementType {
  INFO_ERRONNEE
  CORRUPTION
  FERME
  PRIX_INCORRECT
  AUTRE

  @@map("signalement_type")
}

model Signalement {
  id          String          @id @default(uuid())
  lieuId      String?         @map("lieu_id")
  serviceId   String?         @map("service_id")
  type        SignalementType
  description String          @db.Text
  userId      String?         @map("user_id")
  email       String?         @db.VarChar(100)
  traite      Boolean         @default(false)
  createdAt   DateTime        @default(now()) @map("created_at")
  updatedAt   DateTime        @updatedAt @map("updated_at")

  // Relations
  lieu Lieu? @relation(fields: [lieuId], references: [id])

  @@index([lieuId])
  @@index([traite])
  @@map("signalements")
}

model Favori {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  lieuId    String   @map("lieu_id")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  lieu Lieu @relation(fields: [lieuId], references: [id], onDelete: Cascade)

  @@unique([userId, lieuId])
  @@index([userId])
  @@map("favoris")
}

// ============================================
// DOCUMENT REFERENCE TABLE
// ============================================

model Document {
  id               String           @id @default(uuid())
  nom              String           @db.VarChar(300)
  slug             String           @unique @db.VarChar(300) // URL-friendly, accent-stripped
  categorie        ServiceCategorie
  description      String?          @db.Text
  definition       String?          @db.Text    // What is this document
  role             String?          @db.Text    // What it's used for
  prixEstimatif    Decimal?         @map("prix_estimatif") @db.Decimal(12, 2)
  devise           String           @default("FC") @db.VarChar(10)
  delaiEstimatif   String?          @map("delai_estimatif") @db.VarChar(100)
  documentsRequis  String[]         @map("documents_requis")     // prerequisite docs
  procedure        String?          @db.Text    // Step-by-step
  ouObtenir        String?          @map("ou_obtenir") @db.Text  // Where to get it
  conseils         String?          @db.Text    // Practical tips
  baseJuridique    String?          @map("base_juridique") @db.Text
  aliases          String[]         // alternative search names ("passe port", "deces", etc.)
  commentaire      String?          @db.Text
  actif            Boolean          @default(true)
  createdAt        DateTime         @default(now()) @map("created_at")
  updatedAt        DateTime         @updatedAt @map("updated_at")

  @@index([categorie])
  @@index([nom])
  @@map("documents")
}

// ============================================
// SEARCH & ANALYTICS TABLES
// ============================================

model SearchHistory {
  id        String   @id @default(uuid())
  userId    String?  @map("user_id")
  query     String   @db.VarChar(200)
  filters   Json?
  resultCount Int?   @map("result_count")
  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([query])
  @@map("search_history")
}

model Alerte {
  id        String   @id @default(uuid())
  titre     String   @db.VarChar(200)
  message   String   @db.Text
  type      String   @db.VarChar(50)
  communeId String?  @map("commune_id")
  actif     Boolean  @default(true)
  dateDebut DateTime @map("date_debut")
  dateFin   DateTime? @map("date_fin")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([actif])
  @@index([communeId])
  @@map("alertes")
}

// ============================================
// FAQ TABLE
// ============================================

model Faq {
  id        String            @id @default(uuid())
  question  String            @db.Text
  reponse   String            @db.Text
  categorie ServiceCategorie?
  ordre     Int               @default(0)
  actif     Boolean           @default(true)
  createdAt DateTime          @default(now()) @map("created_at")
  updatedAt DateTime          @updatedAt @map("updated_at")

  @@index([categorie])
  @@map("faqs")
}

// ============================================
// PRIX SIGNALÉ (Comparateur)
// ============================================

model PrixSignale {
  id          String   @id @default(uuid())
  serviceNom  String   @map("service_nom") @db.VarChar(300)
  documentSlug String? @map("document_slug") @db.VarChar(300)
  categorie   ServiceCategorie?
  prixPaye    Decimal  @map("prix_paye") @db.Decimal(12, 2)
  devise      String   @default("FC") @db.VarChar(10)
  lieuNom     String?  @map("lieu_nom") @db.VarChar(300)
  communeNom  String?  @map("commune_nom") @db.VarChar(100)
  commentaire String?  @db.Text
  userId      String?  @map("user_id")
  verifie     Boolean  @default(false)
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([serviceNom])
  @@index([documentSlug])
  @@index([categorie])
  @@map("prix_signales")
}
